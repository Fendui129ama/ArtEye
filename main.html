<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ArtEye — Digital Art Launchpad · crafta</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg: #0c0e12;
      --bg-card: #141820;
      --bg-hover: #1a1f2a;
      --border: #2a3142;
      --accent: #e07c54;
      --accent-soft: rgba(224, 124, 84, 0.2);
      --mint: #6bcfb4;
      --mint-soft: rgba(107, 207, 180, 0.15);
      --text: #e4e6eb;
      --text-dim: #8b92a0;
      --radius: 10px;
      --font-sans: 'DM Sans', sans-serif;
      --font-display: 'Syne', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image: radial-gradient(ellipse 100% 60% at 50% -10%, rgba(44,52,70,0.35), transparent);
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      padding-bottom: 1.25rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1.25rem;
    }
    .logo {
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 1.65rem;
      letter-spacing: 0.02em;
      color: var(--accent);
    }
    .tagline { font-size: 0.8rem; color: var(--text-dim); margin-top: 0.15rem; }
    .header-right { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
    .contract-wrap { display: flex; align-items: center; gap: 0.5rem; }
    input.contract {
      width: 240px;
      padding: 0.45rem 0.65rem;
      font-family: var(--font-mono);
      font-size: 0.8rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: var(--radius);
    }
    input.contract:focus { outline: none; border-color: var(--accent); }
    .addr {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--mint);
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .btn {
      font-family: var(--font-sans);
      font-weight: 500;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text);
      cursor: pointer;
      border-radius: var(--radius);
      font-size: 0.9rem;
      transition: border-color 0.2s, background 0.2s;
    }
    .btn:hover { border-color: var(--accent); background: var(--bg-hover); }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn.primary:hover { filter: brightness(1.1); }
    .btn.small { padding: 0.35rem 0.7rem; font-size: 0.85rem; }
    .tabs { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-bottom: 1.25rem; }
    .tab {
      padding: 0.55rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-dim);
      cursor: pointer;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 500;
    }
    .tab:hover { color: var(--text); }
    .tab.active { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
    .panel { display: none; }
    .panel.visible { display: block; }
    .stats-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 0.85rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.85rem;
    }
    .stats-bar span { color: var(--text-dim); }
    .stats-bar strong { color: var(--accent); margin-right: 0.2rem; }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.15rem;
      margin-bottom: 1rem;
    }
    .card h3 { font-family: var(--font-display); font-size: 1rem; margin-bottom: 0.75rem; color: var(--accent); font-weight: 600; }
    .card h4 { font-size: 0.9rem; margin: 0.75rem 0 0.4rem; color: var(--text-dim); font-weight: 500; }
    label { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.25rem; }
    .input, textarea, select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: var(--radius);
      margin-bottom: 0.6rem;
    }
    .input:focus, select:focus { outline: none; border-color: var(--accent); }
    textarea { min-height: 90px; resize: vertical; }
    .row { display: flex; gap: 1rem; flex-wrap: wrap; }
    .row .card { flex: 1; min-width: 260px; }
    .actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
    .msg { padding: 0.55rem 0.75rem; border-radius: var(--radius); margin-top: 0.5rem; font-size: 0.85rem; }
    .msg.ok { background: var(--mint-soft); border: 1px solid var(--mint); color: var(--mint); }
    .msg.err { background: rgba(224,124,84,0.15); border: 1px solid var(--accent); color: var(--accent); }
    .msg.info { background: var(--accent-soft); border: 1px solid var(--accent); color: var(--accent); }
    .list { list-style: none; }
    .list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.6rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    .list li:last-child { border-bottom: none; }
    .list .mono { font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-dim); }
    .drop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .drop-tile {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      transition: border-color 0.2s;
    }
    .drop-tile:hover { border-color: var(--accent); }
    .drop-tile h4 { font-family: var(--font-display); font-size: 0.95rem; margin-bottom: 0.5rem; color: var(--text); }
    .drop-tile .meta { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.35rem; }
    .drop-tile .supply { font-family: var(--font-mono); font-size: 0.85rem; color: var(--mint); }
    .drop-tile .price { font-family: var(--font-mono); font-size: 0.9rem; color: var(--accent); margin-top: 0.5rem; }
    .drop-tile.badge-live { border-left: 3px solid var(--mint); }
    .drop-tile.badge-paused { border-left: 3px solid var(--accent); opacity: 0.85; }
    .empty-state { text-align: center; padding: 2rem; color: var(--text-dim); font-size: 0.95rem; }
    .empty-state p { margin-top: 0.5rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="logo">ArtEye</div>
        <p class="tagline">Digital art launchpad · Drops · Phases · crafta</p>
      </div>
      <div class="header-right">
        <div class="contract-wrap">
          <input type="text" id="contract-address" class="contract" placeholder="crafta contract 0x..." title="Deployed crafta address" />
          <button type="button" class="btn small" id="btn-attach">Attach</button>
        </div>
        <span class="addr" id="wallet-addr">—</span>
        <button type="button" class="btn primary" id="btn-connect">Connect wallet</button>
      </div>
    </header>

    <div class="stats-bar" id="stats-bar" style="display:none;">
      <span>Creators: <strong id="stat-creators">0</strong></span>
      <span>Drops: <strong id="stat-drops">0</strong></span>
      <span>Launchpad: <strong id="stat-paused">—</strong></span>
    </div>

    <div class="tabs">
      <button type="button" class="tab active" data-tab="drops">Drops</button>
      <button type="button" class="tab" data-tab="creators">Creators</button>
      <button type="button" class="tab" data-tab="mint">Mint</button>
      <button type="button" class="tab" data-tab="collection">My collection</button>
      <button type="button" class="tab" data-tab="config">Config</button>
    </div>

    <div id="panel-drops" class="panel visible">
      <div class="card">
        <h3>Active &amp; upcoming drops</h3>
        <p class="meta" style="margin-bottom:0.75rem; color:var(--text-dim); font-size:0.85rem;">Drops with an active mint phase or scheduled. Attach contract and connect wallet to interact.</p>
        <div class="drop-grid" id="drops-grid"></div>
        <div class="empty-state" id="drops-empty" style="display:none;">
          <p>No drops yet or contract not attached.</p>
        </div>
      </div>
    </div>

    <div id="panel-creators" class="panel">
      <div class="card">
        <h3>Creators</h3>
        <p class="meta" style="margin-bottom:0.75rem; color:var(--text-dim); font-size:0.85rem;">Onboarded creators and their drop counts.</p>
        <ul class="list" id="creators-list"></ul>
        <div class="empty-state" id="creators-empty" style="display:none;">No creators or contract not attached.</div>
      </div>
    </div>

    <div id="panel-mint" class="panel">
      <div class="row">
        <div class="card">
          <h3>Mint from drop</h3>
          <label>Drop ID</label>
          <input type="number" id="mint-drop-id" class="input" min="1" placeholder="1" />
          <label>Phase index (0-based)</label>
          <input type="number" id="mint-phase" class="input" min="0" value="0" placeholder="0" />
          <label>Quantity</label>
          <input type="number" id="mint-qty" class="input" min="1" value="1" placeholder="1" />
          <label>Merkle proof (hex, comma-separated; leave empty if public)</label>
          <input type="text" id="mint-proof" class="input" placeholder="0x...,0x..." />
          <div class="actions">
            <button type="button" class="btn primary" id="btn-mint">Mint</button>
            <button type="button" class="btn" id="btn-check-mint">Check eligibility</button>
          </div>
          <div id="mint-msg"></div>
        </div>
        <div class="card">
          <h3>Drop info</h3>
          <p class="meta" style="margin-bottom:0.5rem;">After selecting a drop, fetch details here.</p>
          <div class="actions">
            <button type="button" class="btn small" id="btn-load-drop">Load drop</button>
          </div>
          <div id="drop-detail" style="margin-top:0.75rem; font-size:0.85rem; color:var(--text-dim);"></div>
        </div>
      </div>
    </div>

    <div id="panel-collection" class="panel">
      <div class="card">
        <h3>My collection</h3>
        <p class="meta" style="margin-bottom:0.75rem; color:var(--text-dim); font-size:0.85rem;">Drops you have minted from. Connect wallet and attach contract.</p>
        <ul class="list" id="collection-list"></ul>
        <div class="empty-state" id="collection-empty" style="display:none;">No mints or wallet not connected.</div>
      </div>
    </div>

    <div id="panel-config" class="panel">
      <div class="row">
        <div class="card">
          <h3>Contract config</h3>
          <p class="meta" style="margin-bottom:0.75rem; color:var(--text-dim); font-size:0.85rem;">Immutable addresses and constants from the attached crafta contract.</p>
          <div class="actions">
            <button type="button" class="btn small" id="btn-load-config">Load config</button>
          </div>
          <div id="config-detail" style="margin-top:0.75rem; font-size:0.85rem; font-family:var(--font-mono); color:var(--text-dim); white-space:pre-wrap; word-break:break-all;"></div>
        </div>
        <div class="card">
          <h3>Creator onboarding</h3>
          <p class="meta" style="margin-bottom:0.5rem;">Register as a creator (bytes32 handle). Use hex or string hashed to bytes32.</p>
          <label>Handle hash (bytes32, e.g. keccak256 of string)</label>
          <input type="text" id="creator-handle" class="input" placeholder="0x... or string to hash" />
          <div class="actions">
            <button type="button" class="btn primary" id="btn-onboard-creator">Onboard creator</button>
          </div>
          <div id="onboard-msg" class="msg" style="display:none;"></div>
        </div>
      </div>
      <div class="card">
        <h3>Creator actions</h3>
        <p class="meta" style="margin-bottom:0.75rem;">Schedule a drop, add phases, or withdraw proceeds. You must be an onboarded creator.</p>
        <div class="row">
          <div class="card">
            <h4>Schedule drop</h4>
            <label>Content hash (bytes32)</label>
            <input type="text" id="drop-content-hash" class="input" placeholder="0x..." />
            <label>Max supply</label>
            <input type="number" id="drop-max-supply" class="input" min="1" placeholder="100" />
            <label>Price per mint (wei or ETH)</label>
            <input type="text" id="drop-price" class="input" placeholder="0.01 or 10000000000000000" />
            <label>Platform fee (bps, max 1500)</label>
            <input type="number" id="drop-fee-bps" class="input" min="0" max="1500" value="500" placeholder="500" />
            <label>Max mint per wallet (0 = no limit)</label>
            <input type="number" id="drop-max-per-wallet" class="input" min="0" value="0" placeholder="0" />
            <div class="actions">
              <button type="button" class="btn primary" id="btn-schedule-drop">Schedule drop</button>
            </div>
            <div id="schedule-drop-msg" class="msg" style="display:none;"></div>
          </div>
          <div class="card">
            <h4>Add phase to drop</h4>
            <label>Drop ID</label>
            <input type="number" id="phase-drop-id" class="input" min="1" placeholder="1" />
            <label>Start block</label>
            <input type="number" id="phase-start" class="input" min="0" placeholder="current + 100" />
            <label>End block</label>
            <input type="number" id="phase-end" class="input" min="0" placeholder="current + 10000" />
            <label>Allowlist only?</label>
            <select id="phase-allowlist" class="input">
              <option value="0">No (public)</option>
              <option value="1">Yes</option>
            </select>
            <label>Merkle root (bytes32, if allowlist)</label>
            <input type="text" id="phase-merkle" class="input" placeholder="0x..." />
            <div class="actions">
              <button type="button" class="btn" id="btn-add-phase">Add phase</button>
            </div>
            <div id="add-phase-msg" class="msg" style="display:none;"></div>
          </div>
          <div class="card">
            <h4>Withdraw creator proceeds</h4>
            <label>Drop ID</label>
            <input type="number" id="withdraw-drop-id" class="input" min="1" placeholder="1" />
            <div class="actions">
              <button type="button" class="btn primary" id="btn-withdraw-creator">Withdraw</button>
            </div>
            <div id="withdraw-msg" class="msg" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const contractInput = document.getElementById('contract-address');
      const walletAddrEl = document.getElementById('wallet-addr');
      const btnConnect = document.getElementById('btn-connect');
      const btnAttach = document.getElementById('btn-attach');
      const statsBar = document.getElementById('stats-bar');
      const statCreators = document.getElementById('stat-creators');
      const statDrops = document.getElementById('stat-drops');
      const statPaused = document.getElementById('stat-paused');

      let provider = null;
      let signer = null;
      let contract = null;
      let contractAddress = '';

      const ABI = [
        'function totalCreators() view returns (uint256)',
        'function totalDrops() view returns (uint256)',
        'function launchpadPaused() view returns (bool)',
        'function getAllDropIds() view returns (uint256[])',
        'function getAllCreatorIds() view returns (uint256[])',
        'function getDropConfig(uint256) view returns (uint256 creatorId, bytes32 contentHash, bytes32 labelHash, uint256 maxSupply, uint256 mintedSupply, uint256 pricePerMintWei, uint256 platformFeeBps, uint256 maxMintPerWallet, uint256 createdAtBlock, bool paused, bool finalized)',
        'function getCreatorProfile(uint256) view returns (address creator, bytes32 handleHash, uint256 totalDrops, uint256 totalMintsFromDrops, uint256 registeredAtBlock, bool active)',
        'function getActivePhaseForDrop(uint256) view returns (int8)',
        'function getDropIdsWithActivePhase() view returns (uint256[])',
        'function getDropIdsActiveNow(uint256) view returns (uint256[])',
        'function mint(uint256 dropId, uint8 phaseIndex, uint256 quantity, bytes32[] proof) payable',
        'function canMint(uint256 dropId, uint8 phaseIndex, address wallet, uint256 quantity) view returns (bool ok, uint8 reason)',
        'function getMintedDropIdsByWallet(address) view returns (uint256[])',
        'function getMintCountForWallet(uint256, address) view returns (uint256)',
        'function estimateMintCost(uint256, uint256) view returns (uint256)',
        'function treasury() view returns (address)',
        'function feeRecipient() view returns (address)',
        'function launchpadKeeper() view returns (address)',
        'function deployedBlock() view returns (uint256)',
        'function onboardCreator(bytes32 handleHash)',
        'function scheduleDrop(bytes32 contentHash, uint256 maxSupply, uint256 pricePerMintWei, uint256 platformFeeBps, uint256 maxMintPerWallet) returns (uint256)',
        'function addPhase(uint256 dropId, uint32 startBlock, uint32 endBlock, bool allowlistOnly, bytes32 merkleRoot)',
        'function withdrawCreatorProceeds(uint256 dropId)',
        'function getCreatorIdForDrop(uint256) view returns (uint256)',
        'function getRemainingSupply(uint256) view returns (uint256)',
        'function getPhaseCountForDrop(uint256) view returns (uint8)',
        'function getPhasesForDrop(uint256) view returns (tuple(uint8 phaseIndex, uint32 startBlock, uint32 endBlock, bool allowlistOnly, bytes32 merkleRoot, uint256 phaseMintCap, uint256 phaseMintedCount, bool configured)[])',
        'function creatorIdByAddress(address) view returns (uint256)'
      ];

      function showMsg(containerId, text, type) {
        const el = document.getElementById(containerId);
        if (!el) return;
        el.textContent = text;
        el.className = 'msg ' + (type || 'info');
        el.style.display = 'block';
      }

      function hideMsg(containerId) {
        const el = document.getElementById(containerId);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
      }

      async function connectWallet() {
        try {
          if (!window.ethereum) { showMsg('mint-msg', 'No Ethereum provider (e.g. MetaMask).', 'err'); return; }
          provider = new ethers.BrowserProvider(window.ethereum);
          const accounts = await provider.send('eth_requestAccounts', []);
          if (accounts.length === 0) { showMsg('mint-msg', 'No account selected.', 'err'); return; }
          signer = await provider.getSigner();
          const addr = await signer.getAddress();
          walletAddrEl.textContent = addr.slice(0, 6) + '…' + addr.slice(-4);
          walletAddrEl.title = addr;
          if (contractAddress) attachContract(contractAddress);
          loadTabs();
        } catch (e) {
          console.error(e);
          showMsg('mint-msg', e.message || 'Connect failed.', 'err');
        }
      }

      function attachContract(addr) {
        const a = (addr || contractInput.value || '').trim();
        if (!ethers.isAddress(a)) {
          showMsg('mint-msg', 'Invalid contract address.', 'err');
          return;
        }
        contractAddress = a;
        contractInput.value = a;
        try {
          contract = new ethers.Contract(a, ABI, signer || provider);
          statsBar.style.display = 'flex';
          loadStats();
          loadTabs();
        } catch (e) {
          console.error(e);
          showMsg('mint-msg', e.message || 'Attach failed.', 'err');
        }
      }

      async function loadStats() {
        if (!contract) return;
        try {
          const [creators, drops, paused] = await Promise.all([
            contract.totalCreators(),
            contract.totalDrops(),
            contract.launchpadPaused()
          ]);
          statCreators.textContent = creators.toString();
          statDrops.textContent = drops.toString();
          statPaused.textContent = paused ? 'Paused' : 'Live';
          statPaused.style.color = paused ? 'var(--accent)' : 'var(--mint)';
        } catch (e) {
          console.error(e);
        }
      }

      async function loadDrops() {
        const grid = document.getElementById('drops-grid');
        const empty = document.getElementById('drops-empty');
        grid.innerHTML = '';
        empty.style.display = 'none';
        if (!contract) { empty.style.display = 'block'; empty.querySelector('p').textContent = 'Attach a crafta contract first.'; return; }
        try {
          const ids = await contract.getDropIdsActiveNow(50);
          const numIds = Array.isArray(ids) ? ids.length : (ids && ids.length !== undefined ? Number(ids.length) : 0);
          if (numIds === 0) {
            const allIds = await contract.getAllDropIds();
            const len = Array.isArray(allIds) ? allIds.length : (allIds && allIds.length !== undefined ? Number(allIds.length) : 0);
            if (len === 0) { empty.style.display = 'block'; return; }
            for (let i = 0; i < Math.min(len, 20); i++) {
              const did = allIds[i];
              await appendDropTile(grid, did, false);
            }
          } else {
            for (let i = 0; i < numIds; i++) {
              const did = ids[i];
              if (did !== undefined && did !== null) await appendDropTile(grid, did, true);
            }
          }
          if (grid.children.length === 0) empty.style.display = 'block';
        } catch (e) {
          console.error(e);
          empty.style.display = 'block';
          empty.querySelector('p').textContent = 'Failed to load drops: ' + (e.message || 'error');
        }
      }

      async function appendDropTile(grid, dropId, isActive) {
        try {
          const cfg = await contract.getDropConfig(dropId);
          const creatorId = cfg[0];
          const maxSupply = cfg[3];
          const mintedSupply = cfg[4];
          const priceWei = cfg[5];
          const paused = cfg[9];
          const finalized = cfg[10];
          const div = document.createElement('div');
          div.className = 'drop-tile' + (isActive ? ' badge-live' : (paused ? ' badge-paused' : ''));
          const priceEth = ethers.formatEther(priceWei || 0);
          div.innerHTML = '<h4>Drop #' + dropId + '</h4>' +
            '<div class="meta">Creator ID: ' + creatorId + (finalized ? ' · Finalized' : '') + '</div>' +
            '<div class="supply">' + mintedSupply + ' / ' + maxSupply + ' minted</div>' +
            '<div class="price">' + priceEth + ' ETH per mint</div>';
          grid.appendChild(div);
        } catch (_) {}
      }

      async function loadCreators() {
        const list = document.getElementById('creators-list');
        const empty = document.getElementById('creators-empty');
        list.innerHTML = '';
        empty.style.display = 'none';
        if (!contract) { empty.style.display = 'block'; return; }
        try {
          const ids = await contract.getAllCreatorIds();
          const len = Array.isArray(ids) ? ids.length : (ids && ids.length !== undefined ? Number(ids.length) : 0);
          if (len === 0) { empty.style.display = 'block'; return; }
          for (let i = 0; i < len; i++) {
            const cid = ids[i];
            try {
              const profile = await contract.getCreatorProfile(cid);
              const li = document.createElement('li');
              li.innerHTML = '<span>Creator #' + cid + ' · ' + (profile[1] && profile[1] !== '0x' + '0'.repeat(64) ? '0x' + profile[1].slice(2, 10) + '…' : '—') + '</span>' +
                '<span class="mono">Drops: ' + profile[2] + ' · Mints: ' + profile[3] + (profile[5] ? '' : ' · Inactive') + '</span>';
              list.appendChild(li);
            } catch (_) {}
          }
        } catch (e) {
          console.error(e);
          empty.style.display = 'block';
        }
      }

      async function loadCollection() {
        const list = document.getElementById('collection-list');
        const empty = document.getElementById('collection-empty');
        list.innerHTML = '';
        empty.style.display = 'none';
        if (!contract || !signer) { empty.style.display = 'block'; empty.textContent = 'Connect wallet and attach contract.'; return; }
        try {
          const addr = await signer.getAddress();
          const dropIds = await contract.getMintedDropIdsByWallet(addr);
          const len = Array.isArray(dropIds) ? dropIds.length : (dropIds && dropIds.length !== undefined ? Number(dropIds.length) : 0);
          if (len === 0) { empty.style.display = 'block'; return; }
          const seen = new Set();
          for (let i = 0; i < len; i++) {
            const did = dropIds[i];
            if (seen.has(String(did))) continue;
            seen.add(String(did));
            const count = await contract.getMintCountForWallet(did, addr);
            const li = document.createElement('li');
            li.innerHTML = '<span>Drop #' + did + '</span><span class="mono">Minted: ' + count + '</span>';
            list.appendChild(li);
          }
        } catch (e) {
          console.error(e);
          empty.style.display = 'block';
        }
      }

      async function loadDropDetail() {
        const out = document.getElementById('drop-detail');
        const dropId = document.getElementById('mint-drop-id').value.trim();
        if (!contract || !dropId) { out.textContent = 'Enter drop ID and attach contract.'; return; }
        try {
          const cfg = await contract.getDropConfig(dropId);
          const remaining = await contract.getRemainingSupply(dropId);
          const phaseCount = await contract.getPhaseCountForDrop(dropId);
          const activePhase = await contract.getActivePhaseForDrop(dropId);
          out.textContent = 'Creator: ' + cfg[0] + '\nMinted: ' + cfg[4] + ' / ' + cfg[3] + '\nRemaining: ' + remaining + '\nPrice: ' + ethers.formatEther(cfg[5]) + ' ETH\nPhases: ' + phaseCount + '\nActive phase index: ' + (Number(activePhase) < 0 ? 'none' : activePhase) + '\nPaused: ' + cfg[9] + ' Finalized: ' + cfg[10];
        } catch (e) {
          out.textContent = 'Error: ' + (e.message || 'unknown');
        }
      }

      async function doMint() {
        hideMsg('mint-msg');
        const dropId = document.getElementById('mint-drop-id').value.trim();
        const phase = document.getElementById('mint-phase').value.trim() || '0';
        const qty = document.getElementById('mint-qty').value.trim() || '1';
        const proofRaw = document.getElementById('mint-proof').value.trim();
        if (!contract || !signer || !dropId) { showMsg('mint-msg', 'Connect wallet, attach contract, and set drop ID.', 'err'); return; }
        let proof = [];
        if (proofRaw) {
          proof = proofRaw.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
        }
        try {
          const cost = await contract.estimateMintCost(dropId, qty);
          const tx = await contract.mint(dropId, phase, qty, proof, { value: cost });
          showMsg('mint-msg', 'Tx sent: ' + tx.hash + '. Waiting for confirmation…', 'info');
          await tx.wait();
          showMsg('mint-msg', 'Mint confirmed.', 'ok');
          loadDropDetail();
          loadCollection();
          loadStats();
        } catch (e) {
          console.error(e);
          showMsg('mint-msg', e.message || 'Mint failed.', 'err');
        }
      }

      async function checkMint() {
        hideMsg('mint-msg');
        const dropId = document.getElementById('mint-drop-id').value.trim();
        const phase = document.getElementById('mint-phase').value.trim() || '0';
        const qty = document.getElementById('mint-qty').value.trim() || '1';
        if (!contract || !signer) { showMsg('mint-msg', 'Connect wallet and attach contract.', 'err'); return; }
        try {
          const addr = await signer.getAddress();
          const [ok, reason] = await contract.canMint(dropId, phase, addr, qty);
          if (ok) showMsg('mint-msg', 'You can mint.', 'ok');
          else showMsg('mint-msg', 'Cannot mint. Reason code: ' + reason + ' (e.g. 6=not started, 7=ended, 8=supply, 9=wallet cap, 12=allowlist required).', 'err');
        } catch (e) {
          showMsg('mint-msg', e.message || 'Check failed.', 'err');
        }
      }

      async function loadConfig() {
        const out = document.getElementById('config-detail');
        if (!contract) { out.textContent = 'Attach contract first.'; return; }
        try {
          const [treasury, feeRecipient, keeper, deployedBlock] = await Promise.all([
